# External Dependencies - Integration Points

## QuPath Integration Points

### Core API Usage
- **Extension Loading**: Extend `QuPathExtension` and implement `GitHubProject` interface in `SetupScope.java`
- **Menu System**: Use `QuPathGUI.getMenu()` to create extension menus and register menu items
- **Project Management**: 
  - `QuPathGUI.getProject()` for accessing current project
  - `Project.addImage()` for importing stitched acquisition results
  - Project creation and management through `QPProjectFunctions`
- **Image Data Access**:
  - `QuPathGUI.getImageData()` for current image access
  - `PathObject` hierarchy manipulation for annotations
  - `PathObject.getROI().getBounds2D()` for extracting bounding box coordinates
  - `ImageData.getHierarchy()` for annotation management and event listening
- **Coordinate Systems**: 
  - Transform between QuPath pixel coordinates and physical microscope coordinates
  - Handle image flipping and rotation via `TransformationFunctions`
- **Current Target Version**: QuPath 0.6.0-rc4

### UI Integration
- JavaFX integration with QuPath's UI threading model
- Use `Platform.runLater()` for UI updates from background threads
- Progress dialog integration using QuPath's dialog system

## Socket Communication (Pycro-Manager Integration)

### Protocol Details
- **Transport**: TCP sockets with binary protocol
- **Server**: Python-based microscope control server (Pycro-Manager)
- **Client**: Java-based `MicroscopeSocketClient` in QPSC extension
- **Port**: Configurable (default varies by setup)
- **Data Format**: Big-endian byte order for numeric data

### Command Set
- **Stage Control**: `GETXY`, `GETZ`, `GETR`, `MOVE`, `MOVEZ`, `MOVER`
- **Field of View**: `GETFOV` - returns camera FOV dimensions in microns
- **Acquisition**: `ACQUIRE` - starts acquisition with command string
- **Monitoring**: `STATUS`, `PROGRESS` - real-time acquisition monitoring
- **Control**: `CANCEL`, `DISCONNECT`, `SHUTDOWN`

### Connection Management  
- Persistent connections with automatic reconnection
- Health monitoring via periodic heartbeat checks
- Thread-safe command execution with connection pooling
- Graceful handling of network interruptions

### Data Exchange Format
- Commands: Fixed 8-byte ASCII strings
- Stage positions: 32-bit floats (X, Y, Z coordinates in microns)
- Acquisition commands: UTF-8 text strings with `END_MARKER` terminator
- Status responses: 16-byte padded strings for acquisition state
- Progress data: 32-bit integers for current/total counts

## Text File Outputs and Templates

### Acquisition Configuration Files
- **TileConfiguration.txt**: ImageJ/Fiji format tile positioning data
  - Generated by `TilingUtilities.generateTileConfig()`
  - Contains relative tile positions for stitching
  - Automatically transformed for coordinate system alignment
- **TileConfiguration_QP.txt**: Backup of original tile configuration
- **Acquisition Command Files**: 
  - Format: `acquisition_command_<timestamp>.txt`
  - Contains full command parameters sent to Pycro-Manager
  - Template potentially read by Python and other software (as of 2025-09-04)

### Metadata Files
- **Stage Coordinate Files**: `<image>_StageCoordinates.txt`
  - Physical stage positions for each image
  - Used for coordinate transformations
- **JSON Metadata**: Pretty-printed acquisition metadata for debugging
- **Affine Transform Files**: JSON format transformation matrices
- **Groovy Scripts**: Generated QuPath scripts for tissue detection and processing

### File Locations
- Tile configurations: `<acquisition_folder>/bounds/TileConfiguration.txt`
- Per-annotation configs: `<acquisition_folder>/<annotation_name>/TileConfiguration.txt`
- Metadata: Alongside acquired images and in project directories

## External Command Execution

### Python Process Management
- **Heartbeat Client**: Launch Python scripts via `ProcessBuilder`
- **Test Workflows**: Execute `heartbeat_client.py` for connectivity testing
- **Process Monitoring**: Track Python process health and termination

### System Commands
- **ImageJ/Fiji Integration**: Execute external processing via `TileProcessingUtilities.execCommand()`
- **File Operations**: Zip compression, file cleanup, and directory management
- **Stitching Integration**: Launch external stitching tools when needed

## Configuration Dependencies

### YAML Configuration System
- **Microscope Config**: Hardware-specific settings, modalities, acquisition profiles
- **LOCI Resources**: Shared hardware component lookup tables (`resources_LOCI.yml`)
- **Hierarchical Loading**: Base → Microscope → Modality → User overrides
- **Dynamic Reference Resolution**: Automatic `LOCI-*` reference lookup

### Required Configuration Sections
- `microscope`: Basic microscope identity and default settings
- `stage`: Physical stage limits and component IDs
- `modalities`: Imaging mode definitions and parameters
- `hardware`: Available objectives (with pixel sizes) and detectors

## Version Compatibility

### Critical Dependencies
- **QuPath**: 0.6.0-rc4 (API compatibility for PathObject, Project, ImageData)
- **JavaFX**: 17.0.2 (UI components and threading)
- **Java**: 21+ (required by QuPath and modern language features)
- **Pycro-Manager**: Socket protocol compatibility (command set and data formats)

## Recent Changes That Affected Us
- 2025-09-04: Added new template to acquisition command text files for Python/external software compatibility

## TODO: Monitor These Regularly
- **QuPath GitHub releases**: API changes in PathObject, Project, ImageData interfaces
- **Pycro-Manager updates**: Socket protocol changes, command set modifications
- **JavaFX versions**: UI compatibility and threading model changes
- **Bio-Formats updates**: Image format support and metadata handling
- **Tiles-to-Pyramid extension**: Stitching and pyramid generation compatibility